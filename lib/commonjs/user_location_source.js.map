{"version":3,"sources":["user_location_source.tsx"],"names":["UserLocationSource","undefined","location","Proximiio","heading","setState","forceUpdate","styleSub","ProximiioMapbox","subscribe","ProximiioMapboxEvents","STYLE_CHANGED","onChange","featuresSub","FEATURES_CHANGED","locationSub","LOCATION_UPDATED","onLocationUpdated","CompassHeading","start","accuracy","props","onAccuracyChanged","onHeadingChanged","remove","stop","visible","state","styles","getDefaultStyle","outerRing","markerOuterRingStyle","middleRing","markerMiddleRingStyle","innerRing","markerInnerRingStyle","headingStyle","lng","lat","createIcon","showHeadingIndicator","React","Component","showsUserHeadingIndicator","layerCount","style","layers","length","coneIndex","markerIndex","Constants","LAYER_USER_MARKER_CONE","LAYER_USER_MARKER_1","LAYER_ROUTING_SYMBOLS","LAYER_USER_MARKER_2","LAYER_USER_MARKER_3","proximiBlue","getHeadingIndicatorStyle","circleRadius","circleColor","circleOpacity","circlePitchAlignment","iconRotation","iconImage","headingImage","iconSize","iconAllowOverlap","iconRotate","iconRotationAlignment"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport MapboxGL, {\n  CircleLayerStyle,\n  SymbolLayerStyle\n} from '@react-native-mapbox-gl/maps';\nimport ProximiioMapbox, {ProximiioMapboxEvents}  from './instance';\nimport Proximiio, {ProximiioLocation} from 'react-native-proximiio';\nimport CompassHeading from 'react-native-compass-heading';\n// @ts-ignore\nimport headingImage from './assets/heading_cone.png';\n// @ts-ignore\nimport Annotation from '@react-native-mapbox-gl/maps/javascript/components/annotations/Annotation';\nimport Constants from './constants';\nimport { EmitterSubscription } from 'react-native';\n\ninterface Props {\n  onAccuracyChanged?: (accuracy: number) => void;\n  onHeadingChanged?: (heading: number) => void;\n  headingStyle?: SymbolLayerStyle;\n  markerOuterRingStyle?: CircleLayerStyle;\n  markerMiddleRingStyle?: CircleLayerStyle;\n  markerInnerRingStyle?: CircleLayerStyle;\n  showHeadingIndicator?: boolean;\n  visible?: boolean;\n}\ninterface State {\n  heading?: number;\n  location?: ProximiioLocation;\n}\n\nexport class UserLocationSource extends React.Component<Props, State> {\n  private styleSub?: EmitterSubscription;\n  private featuresSub?: EmitterSubscription;\n  private locationSub?: EmitterSubscription;\n\n  private accuracy = undefined;\n  state = {\n    location: Proximiio.location,\n    heading: 0,\n  } as State;\n\n  componentDidMount() {\n    this.styleSub = ProximiioMapbox.subscribe(ProximiioMapboxEvents.STYLE_CHANGED, this.onChange);\n    this.featuresSub = ProximiioMapbox.subscribe(ProximiioMapboxEvents.FEATURES_CHANGED, this.onChange);\n    this.locationSub =ProximiioMapbox.subscribe(ProximiioMapboxEvents.LOCATION_UPDATED, this.onLocationUpdated);\n\n    CompassHeading.start(2, ({heading, accuracy}) => {\n      this.setState({heading: heading});\n      if (this.accuracy !== accuracy && this.props.onAccuracyChanged) {\n        this.accuracy = accuracy;\n        this.props.onAccuracyChanged(accuracy);\n      }\n      if (this.props.onHeadingChanged) {\n        this.props.onHeadingChanged(heading);\n      }\n    });\n  }\n\n  componentWillUnmount() {\n    this.styleSub?.remove();\n    this.featuresSub?.remove();\n    this.locationSub?.remove();\n    CompassHeading.stop();\n  }\n\n  render() {\n    if (!this.props.visible || !this.state.location) {\n      return null;\n    }\n\n    let styles = getDefaultStyle(this.state.heading || 0);\n    styles.outerRing = {...styles.outerRing, ...this.props.markerOuterRingStyle};\n    styles.middleRing = {...styles.middleRing, ...this.props.markerMiddleRingStyle};\n    styles.innerRing = {...styles.innerRing, ...this.props.markerInnerRingStyle};\n    styles.heading = {...styles.heading, ...this.props.headingStyle};\n\n    return (\n      <Annotation\n        id=\"proximiUserLocation\"\n        animated={true}\n        key={'proximiioUserAnnotation'}\n        coordinates={this.state.location ? [this.state.location.lng, this.state.location.lat] : null}>\n        {createIcon(styles, this.props.showHeadingIndicator)}\n      </Annotation>\n    );\n  }\n\n  private onLocationUpdated = (location: ProximiioLocation) => {\n    this.setState({location: location});\n  };\n\n  private onChange = () => {\n    this.forceUpdate();\n  };\n}\n\nexport const createIcon = (styles: Styles, showsUserHeadingIndicator?: boolean) => {\n  const layerCount = ProximiioMapbox.style?.layers.length ?? 100;\n  const coneIndex = layerCount + 1;\n  const markerIndex = coneIndex + 1;\n\n  return [\n    (showsUserHeadingIndicator ?\n      <MapboxGL.SymbolLayer\n        key={Constants.LAYER_USER_MARKER_CONE}\n        id={Constants.LAYER_USER_MARKER_CONE}\n        // aboveLayerID={Constants.LAYER_ROUTING_SYMBOLS}\n        layerIndex={coneIndex}\n        style={styles.heading}\n      /> : []),\n    <MapboxGL.CircleLayer\n      key={Constants.LAYER_USER_MARKER_1}\n      id={Constants.LAYER_USER_MARKER_1}\n      style={styles.outerRing}\n      layerIndex={markerIndex}\n      aboveLayerID={showsUserHeadingIndicator ? Constants.LAYER_USER_MARKER_CONE : Constants.LAYER_ROUTING_SYMBOLS}\n    />,\n    <MapboxGL.CircleLayer\n      key={Constants.LAYER_USER_MARKER_2}\n      id={Constants.LAYER_USER_MARKER_2}\n      aboveLayerID={Constants.LAYER_USER_MARKER_1}\n      style={styles.middleRing}\n    />,\n    <MapboxGL.CircleLayer\n      key={Constants.LAYER_USER_MARKER_3}\n      id={Constants.LAYER_USER_MARKER_3}\n      aboveLayerID={Constants.LAYER_USER_MARKER_2}\n      style={styles.innerRing}\n    />,\n  ]\n};\n\nconst proximiBlue = 'rgb(59,143,214)';\n\n\ninterface Styles {\n  heading: SymbolLayerStyle;\n  outerRing: CircleLayerStyle;\n  middleRing: CircleLayerStyle;\n  innerRing: CircleLayerStyle;\n}\n\nconst getDefaultStyle = (heading: number): Styles => {\n  return {\n    heading: getHeadingIndicatorStyle(heading),\n    outerRing: {\n      circleRadius: 16,\n      circleColor: proximiBlue,\n      circleOpacity: 0.2,\n      circlePitchAlignment: 'map',\n    },\n    middleRing: {\n      circleRadius: 15,\n      circleColor: '#fff',\n      circlePitchAlignment: 'map',\n    },\n    innerRing: {\n      circleRadius: 10,\n      circleColor: proximiBlue,\n      circlePitchAlignment: 'map',\n    }\n  };\n};\n\nconst getHeadingIndicatorStyle = (iconRotation?: number):SymbolLayerStyle => {\n  return {\n    iconImage: headingImage,\n    iconSize: 1.2,\n    iconAllowOverlap: true,\n    iconRotate: iconRotation,\n    iconRotationAlignment: 'map',\n  } as SymbolLayerStyle;\n};\n"]}