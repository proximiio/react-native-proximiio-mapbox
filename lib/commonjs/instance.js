"use strict";var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard");var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=exports.ProximiioMapbox=exports.ProximiioMapboxEvents=exports.ProximiioMapboxSyncStatus=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _reactNative=require("react-native");var _asyncStorage=_interopRequireDefault(require("@react-native-community/async-storage"));var _axios=_interopRequireDefault(require("axios"));var _reactNativeProximiio=_interopRequireWildcard(require("react-native-proximiio"));var _helpers=require("./helpers");var _feature=require("./feature");var _route_managerv=require("./route_managerv2");var ProximiioMapboxNative=_reactNative.NativeModules.ProximiioMapboxNative;var ProximiioMapboxSyncStatus;exports.ProximiioMapboxSyncStatus=ProximiioMapboxSyncStatus;(function(ProximiioMapboxSyncStatus){ProximiioMapboxSyncStatus["INITIAL_WAITING"]="INITIAL_WAITING";ProximiioMapboxSyncStatus["INITIAL_NETWORK_ERROR"]="INITIAL_NETWORK_ERROR";ProximiioMapboxSyncStatus["INITIAL_RUNNING"]="INITIAL_RUNNING";ProximiioMapboxSyncStatus["INITIAL_ERROR"]="INITIAL_ERROR";ProximiioMapboxSyncStatus["INITIAL_FINISHED"]="INITIAL_FINISHED";ProximiioMapboxSyncStatus["UPDATE_NETWORK_ERROR"]="UPDATE_NETWORK_ERROR";ProximiioMapboxSyncStatus["UPDATE_RUNNING"]="UPDATE_RUNNING";ProximiioMapboxSyncStatus["UPDATE_ERROR"]="UPDATE_ERROR";ProximiioMapboxSyncStatus["UPDATE_FINISHED"]="UPDATE_FINISHED";})(ProximiioMapboxSyncStatus||(exports.ProximiioMapboxSyncStatus=ProximiioMapboxSyncStatus={}));var ProximiioMapboxEvents;exports.ProximiioMapboxEvents=ProximiioMapboxEvents;(function(ProximiioMapboxEvents){ProximiioMapboxEvents["FAILURE"]="ProximiioMapboxInitialized";ProximiioMapboxEvents["READY"]="ProximiioMapboxFailed";ProximiioMapboxEvents["LOCATION_UPDATED"]="ProximiioMapboxLocationUpdate";ProximiioMapboxEvents["ROUTE"]="ProximiioMapbox.RouteEvent";ProximiioMapboxEvents["ROUTE_UPDATE"]="ProximiioMapbox.RouteEventUpdate";ProximiioMapboxEvents["ON_LANDMARK"]="ProximiioMapboxOnNavigationLandmark";ProximiioMapboxEvents["ON_HAZARD"]="ProximiioMapboxOnNavigationHazard";ProximiioMapboxEvents["ON_SEGMENT"]="ProximiioMapboxOnNavigationSegment";ProximiioMapboxEvents["ON_DECISION"]="ProximiioMapboxOnNavigationDecision";ProximiioMapboxEvents["AMENITIES_CHANGED"]="ProximiioMapboxAmenitiesChanged";ProximiioMapboxEvents["FEATURES_CHANGED"]="ProximiioMapboxFeaturesChanged";ProximiioMapboxEvents["STYLE_CHANGED"]="ProximiioMapboxStyleChanged";ProximiioMapboxEvents["SYNC_STATUS"]="ProximiioMapboxSyncStatusChanged";})(ProximiioMapboxEvents||(exports.ProximiioMapboxEvents=ProximiioMapboxEvents={}));var ProximiioMapboxInternalEvents;(function(ProximiioMapboxInternalEvents){ProximiioMapboxInternalEvents["AMENITIES_CHANGED"]="ProximiioMapboxAmenitiesChangedInternal";ProximiioMapboxInternalEvents["FEATURES_CHANGED"]="ProximiioMapboxFeaturesChangedInternal";})(ProximiioMapboxInternalEvents||(ProximiioMapboxInternalEvents={}));var ProximiioMapbox=function(){function ProximiioMapbox(){(0,_classCallCheck2.default)(this,ProximiioMapbox);(0,_defineProperty2.default)(this,"token",'');(0,_defineProperty2.default)(this,"style",void 0);(0,_defineProperty2.default)(this,"axios",void 0);(0,_defineProperty2.default)(this,"emitter",new _reactNative.NativeEventEmitter(ProximiioMapboxNative));(0,_defineProperty2.default)(this,"route",new _route_managerv.ProximiioRouteManager());(0,_defineProperty2.default)(this,"amenityCache",void 0);(0,_defineProperty2.default)(this,"featureCache",void 0);(0,_defineProperty2.default)(this,"isLoadingFeatures",false);this.authorize=this.authorize.bind(this);this.subscribe=this.subscribe.bind(this);this.unsubscribe=this.unsubscribe.bind(this);this.amenityCache=[];this.featureCache=[];}(0,_createClass2.default)(ProximiioMapbox,[{key:"authorize",value:function authorize(token){var _this=this;return _regenerator.default.async(function authorize$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(this.token.length>0)){_context.next=3;break;}console.log('ProximiioMapbox already authorized, skipping');return _context.abrupt("return");case 3:this.token=token;_reactNativeProximiio.default.subscribe(_reactNativeProximiio.ProximiioEvents.PositionUpdated,function(location){ProximiioMapboxNative.updateLocation(location.lat,location.lng,location.sourceType,location.accuracy).then(function(result){_this.emitter.emit(ProximiioMapboxEvents.LOCATION_UPDATED,result);});});_reactNativeProximiio.default.subscribe(_reactNativeProximiio.ProximiioEvents.FloorChanged,function(floor){if(_helpers.isIOS){ProximiioMapboxNative.updateFloor(floor.id);}else{ProximiioMapboxNative.updateLevel(floor.level);}});this.subscribe(ProximiioMapboxEvents.ROUTE,function(evt){return _this.route.onCalculated(evt);});this.subscribe(ProximiioMapboxEvents.ROUTE_UPDATE,function(evt){return _this.route.onUpdate(evt);});this.subscribe(ProximiioMapboxInternalEvents.AMENITIES_CHANGED,this.__amenitiesChanged.bind(this));this.subscribe(ProximiioMapboxInternalEvents.FEATURES_CHANGED,this.__featuresChanged.bind(this));_context.next=12;return _regenerator.default.awrap(ProximiioMapboxNative.authorize(token));case 12:this.axios=_axios.default.create({baseURL:'https://api.proximi.fi',timeout:60000,headers:{'Authorization':"Bearer ".concat(token)}});_context.next=15;return _regenerator.default.awrap(this.axios.get('/v5/geo/style'));case 15:this.style=_context.sent.data;case 16:case"end":return _context.stop();}}},null,this,null,Promise);}},{key:"isReady",value:function isReady(){return ProximiioMapboxNative.isReady();}},{key:"search",value:function search(title){return ProximiioMapboxNative.search(title);}},{key:"getAmenityCategories",value:function getAmenityCategories(){return ProximiioMapboxNative.getAmenityCategories();}},{key:"__amenitiesChanged",value:function __amenitiesChanged(amenities){this.amenityCache=amenities;this.emitter.emit(ProximiioMapboxEvents.AMENITIES_CHANGED);}},{key:"__featuresChanged",value:function __featuresChanged(features){return _regenerator.default.async(function __featuresChanged$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:this.featureCache=features.map(function(f){return new _feature.Feature(_reactNative.Platform.OS==='ios'?f:JSON.parse(f));});this.emitter.emit(ProximiioMapboxEvents.FEATURES_CHANGED);case 2:case"end":return _context2.stop();}}},null,this,null,Promise);}},{key:"getAmenities",value:function getAmenities(){return this.amenityCache;}},{key:"getFeatures",value:function getFeatures(){return this.featureCache;}},{key:"syncFeatures",value:function syncFeatures(){var native;return _regenerator.default.async(function syncFeatures$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return _regenerator.default.awrap(_asyncStorage.default.removeItem('proximiio:features'));case 2:this.isLoadingFeatures=true;if(!(_reactNative.Platform.OS==='ios')){_context3.next=6;break;}_context3.next=6;return _regenerator.default.awrap(ProximiioMapboxNative.syncFeatures());case 6:_context3.next=8;return _regenerator.default.awrap(ProximiioMapboxNative.getFeatures());case 8:native=_context3.sent.map(function(f){return new _feature.Feature(_reactNative.Platform.OS==='ios'?f:JSON.parse(f));});this.featureCache=native;_context3.next=12;return _regenerator.default.awrap(_asyncStorage.default.setItem('proximiio:features',JSON.stringify(this.featureCache)));case 12:this.isLoadingFeatures=false;if(native.length>0){this.emitter.emit(ProximiioMapboxEvents.FEATURES_CHANGED);}case 14:case"end":return _context3.stop();}}},null,this,null,Promise);}},{key:"getStyle",value:function getStyle(){return ProximiioMapboxNative.getStyle();}},{key:"getSyncStatus",value:function getSyncStatus(){return ProximiioMapboxNative.getSyncStatus();}},{key:"startSyncNow",value:function startSyncNow(){ProximiioMapboxNative.startSyncNow();}},{key:"setLevelOverrideMap",value:function setLevelOverrideMap(levelOverrideMap){ProximiioMapboxNative.setLevelOverrideMap(levelOverrideMap);}},{key:"setUnitConversion",value:function setUnitConversion(unitConversion){ProximiioMapboxNative.setUnitConversion(JSON.stringify(unitConversion));}},{key:"setStepImmediateThreshold",value:function setStepImmediateThreshold(thresholdInMeters){ProximiioMapboxNative.setStepImmediateThreshold(thresholdInMeters);}},{key:"setStepPreparationThreshold",value:function setStepPreparationThreshold(thresholdInMeters){ProximiioMapboxNative.setStepPreparationThreshold(thresholdInMeters);}},{key:"setRouteFinishThreshold",value:function setRouteFinishThreshold(thresholdInMeters){ProximiioMapboxNative.setRouteFinishThreshold(thresholdInMeters);}},{key:"setRerouteEnabled",value:function setRerouteEnabled(enabled){ProximiioMapboxNative.setRerouteEnabled(enabled);}},{key:"setReRouteThreshold",value:function setReRouteThreshold(thresholdInMeters){ProximiioMapboxNative.setReRouteThreshold(thresholdInMeters);}},{key:"setUserLocationToRouteSnappingEnabled",value:function setUserLocationToRouteSnappingEnabled(enabled){ProximiioMapboxNative.setUserLocationToRouteSnappingEnabled(enabled);}},{key:"setUserLocationToRouteSnappingThreshold",value:function setUserLocationToRouteSnappingThreshold(threshold){ProximiioMapboxNative.setUserLocationToRouteSnappingThreshold(threshold);}},{key:"ttsEnabled",value:function ttsEnabled(enabled){if(enabled){ProximiioMapboxNative.ttsEnable();}else{ProximiioMapboxNative.ttsDisable();}}},{key:"ttsHeadingCorrectionEnabled",value:function ttsHeadingCorrectionEnabled(enabled){ProximiioMapboxNative.ttsHeadingCorrectionEnabled(enabled);}},{key:"ttsReassuranceInstructionEnabled",value:function ttsReassuranceInstructionEnabled(enabled){ProximiioMapboxNative.ttsReassuranceInstructionEnabled(enabled);}},{key:"ttsReassuranceInstructionDistance",value:function ttsReassuranceInstructionDistance(distance){ProximiioMapboxNative.ttsReassuranceInstructionDistance(distance);}},{key:"ttsRepeatLastInstruction",value:function ttsRepeatLastInstruction(){ProximiioMapboxNative.ttsRepeatLastInstruction();}},{key:"ttsHazardAlert",value:function ttsHazardAlert(enabled){var metadataKeys=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];if(metadataKeys==undefined)metadataKeys=[];ProximiioMapboxNative.ttsHazardAlert(enabled,metadataKeys);}},{key:"ttsSegmentAlert",value:function ttsSegmentAlert(emterEnabled,exitEnabled){var metadataKeys=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];if(metadataKeys==undefined)metadataKeys=[];ProximiioMapboxNative.ttsSegmentAlert(emterEnabled,exitEnabled,metadataKeys);}},{key:"ttsDecisionAlert",value:function ttsDecisionAlert(enabled){var metadataKeys=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];if(metadataKeys==undefined)metadataKeys=[];ProximiioMapboxNative.ttsDecisionAlert(enabled,metadataKeys);}},{key:"ttsLandmarkAlert",value:function ttsLandmarkAlert(enabled){var metadataKeys=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];if(metadataKeys==undefined)metadataKeys=[];ProximiioMapboxNative.ttsLandmarkAlert(enabled,metadataKeys);}},{key:"ttsLevelChangerMetadataKeys",value:function ttsLevelChangerMetadataKeys(metadataKeys){if(metadataKeys==undefined)metadataKeys=[];ProximiioMapboxNative.ttsLevelChangerMetadataKeys(metadataKeys);}},{key:"ttsDestinationMetadataKeys",value:function ttsDestinationMetadataKeys(metadataKeys){if(metadataKeys==undefined)metadataKeys=[];ProximiioMapboxNative.ttsLevelChangerMetadataKeys(metadataKeys);}},{key:"subscribe",value:function subscribe(event,fn){return this.emitter.addListener(event,fn);}},{key:"unsubscribe",value:function unsubscribe(event,fn){return this.emitter.removeListener(event,fn);}},{key:"styleURL",get:function get(){if(this.token===''){throw new Error('ProximiioMapbox is not authorized');}return"https://api.proximi.fi/v5/geo/style?token=".concat(this.token);}}]);return ProximiioMapbox;}();exports.ProximiioMapbox=ProximiioMapbox;var _default=new ProximiioMapbox();exports.default=_default;
//# sourceMappingURL=instance.js.map