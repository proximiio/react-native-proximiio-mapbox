"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.RoutingSource=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));var _extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _react=_interopRequireDefault(require("react"));var _maps=_interopRequireDefault(require("@react-native-mapbox-gl/maps"));var _react2=_interopRequireDefault(require("fast-deep-equal/react"));var _instance=_interopRequireDefault(require("./instance"));var _route_managerv=require("./route_managerv2");var _constants=_interopRequireDefault(require("./constants"));var _feature=require("./feature");var _along=_interopRequireDefault(require("@turf/along"));var _helpers=require("./helpers");var _jsxFileName="/Users/wired/mika/react-native-proximiio-mapbox/src/routing_source.tsx";function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=(0,_getPrototypeOf2.default)(Derived),result;if(hasNativeReflectConstruct){var NewTarget=(0,_getPrototypeOf2.default)(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else{result=Super.apply(this,arguments);}return(0,_possibleConstructorReturn2.default)(this,result);};}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true;}catch(e){return false;}}var completedStyle={lineCap:'round',lineJoin:'round',lineOpacity:1,lineColor:'#999999',lineWidth:10};var remainingStyle={lineCap:'round',lineJoin:'round',lineOpacity:1,lineColor:'#39c6e1',lineWidth:10};var dottedLineStyle={iconImage:'blueDot',iconSize:0.25,symbolPlacement:'point',iconAllowOverlap:false,textAllowOverlap:false};var completedFilterWithLevel=function completedFilterWithLevel(level){return["all",["==",["geometry-type"],"LineString"],["has","completed"],["==",["to-number",["get","level"]],level]];};var remainingFilterWithLevel=function remainingFilterWithLevel(level){return["all",["==",["geometry-type"],"LineString"],["==",["to-number",["get","level"]],level]];};var symbolFilterWithLevel=function symbolFilterWithLevel(level){return["all",["==",["geometry-type"],"Point"],["==",["to-number",["get","level"]],level]];};var lineSymbolFilterWithLevel=function lineSymbolFilterWithLevel(level){return["all",["==",["geometry-type"],"LineString"],["==",["to-number",["get","level"]],level]];};var dottedLineFilter=_helpers.isIOS?["all",["==","usecase","route-line-symbol"]]:['==',['get','usecase'],"route-line-symbol"];var RoutingSource=function(_React$Component){(0,_inherits2.default)(RoutingSource,_React$Component);var _super=_createSuper(RoutingSource);function RoutingSource(props){var _this;(0,_classCallCheck2.default)(this,RoutingSource);_this=_super.call(this,props);(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"onRouteEvent",function(event){if(event===_route_managerv.ProximiioRouteEvents.ROUTE_ENDED){_this.onRouteCanceled();}else if(event==_route_managerv.ProximiioRouteEvents.ROUTE_CALCULATED){_this.onRoutePreview();}else if(event===_route_managerv.ProximiioRouteEvents.ROUTE_PREVIEWED){_this.onRoutePreview();}else if(event===_route_managerv.ProximiioRouteEvents.ROUTE_UPDATED){_this.onRouteUpdated();}});(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"setRouteState",function _callee(routeState){return _regenerator.default.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return _regenerator.default.awrap(_this.update());case 2:_context.next=4;return _regenerator.default.awrap(_this.setState({routeState:routeState}));case 4:case"end":return _context.stop();}}},null,null,null,Promise);});(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"onReady",function _callee2(){return _regenerator.default.async(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(_instance.default.style){_this.setRouteState('off');}case 1:case"end":return _context2.stop();}}},null,null,null,Promise);});(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"onRoutePreview",function _callee3(){return _regenerator.default.async(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(_instance.default.route.route){_this.setRouteState('preview');}case 1:case"end":return _context3.stop();}}},null,null,null,Promise);});(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"onRouteStarted",function _callee4(){return _regenerator.default.async(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:if(_instance.default.route.route){_this.setRouteState('started');}case 1:case"end":return _context4.stop();}}},null,null,null,Promise);});(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"onRouteUpdated",function(){if(_instance.default.route.routeStarted){_this.update();}});(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"onRouteCanceled",function _callee5(){return _regenerator.default.async(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.next=2;return _regenerator.default.awrap(_this.setRouteState('off'));case 2:_context5.next=4;return _regenerator.default.awrap(_this.setState({collection:{type:'FeatureCollection',features:[]}}));case 4:case"end":return _context5.stop();}}},null,null,null,Promise);});(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"update",function _callee6(){var route,previewedOrStarted,features,startIdx,targetIdx,feats,startCoords,start,lastFeature,coordinates,targetCoords,target,feature,lineString,_target,distance,distanceRemaining,separator,chunks,i,point;return _regenerator.default.async(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:route=_instance.default.route.route;previewedOrStarted=_instance.default.route.routePreviewed||_instance.default.route.routeStarted;features=previewedOrStarted&&route?route.features:[];if(_this.props.showSymbols&&features&&features.length>0){startIdx=features.findIndex(function(f){return f.id==='route-start';});targetIdx=features.findIndex(function(f){return f.id==='route-target';});feats=startIdx>=0?features.filter(function(f){return typeof f.id==='undefined';}):features;startCoords=features[0].geometry.coordinates[0];start=_feature.Feature.point('route-start',startCoords[1],startCoords[0],{image:_this.state.startImage,level:features[0].properties.level});lastFeature=feats[feats.length-1];coordinates=lastFeature.geometry.coordinates;targetCoords=Array.isArray(coordinates[0])?coordinates[coordinates.length-1]:coordinates;target=_feature.Feature.point('route-target',targetCoords[1],targetCoords[0],{image:_this.state.targetImage,level:lastFeature.properties.level});if(startIdx===-1){features.push(start);}else{features.splice(startIdx,1,start);}if(targetIdx===-1){features.push(target);}else{features.splice(targetIdx,1,target);}}if(route&&_this.props.dotted){feature=(0,_extends2.default)({},route.features[0]);lineString=[feature.geometry.coordinates[0]];route.features.filter(function(f){return f.geometry.type==='LineString';}).forEach(function(feature,index){var coordinates=(0,_toConsumableArray2.default)(feature.geometry.coordinates);if(index>0){coordinates.shift();}lineString.push.apply(lineString,(0,_toConsumableArray2.default)(coordinates));});_target=features.find(function(f){return f.id==='route-target';});if(_target){lineString.push(_target.geometry.coordinates);}feature.geometry.coordinates=lineString;distance=route.distanceMeters;distanceRemaining=distance;separator=0.5;chunks=[];i=0;while(distanceRemaining>separator){point=(0,_along.default)(feature,(separator+i)/1000);if(point&&point.properties){point.properties.usecase='route-line-symbol';chunks.push(point);distanceRemaining-=separator;i+=separator;}}features.push.apply(features,(0,_toConsumableArray2.default)(chunks));}_this.setState({collection:{type:'FeatureCollection',features:features},completedFilter:completedFilterWithLevel(_this.props.level),remainingFilter:remainingFilterWithLevel(_this.props.level),symbolFilter:symbolFilterWithLevel(_this.props.level),lineSymbolFilter:lineSymbolFilterWithLevel(_this.props.level),syncKey:"routing-source-"+new Date().getTime()},function(){setTimeout(function(){_this.setState({syncKey:"routing-source-"+new Date().getTime()});},1000);});case 6:case"end":return _context6.stop();}}},null,null,null,Promise);});_this.state={collection:{type:'FeatureCollection',features:[]},completedFilter:completedFilterWithLevel(props.level),remainingFilter:remainingFilterWithLevel(props.level),symbolFilter:symbolFilterWithLevel(props.level),lineSymbolFilter:lineSymbolFilterWithLevel(props.level),dashedFilter:_helpers.isIOS?["all",["==","usecase","route-line-symbol"]]:['==',['get','usecase'],"route-line-symbol"],completedIndex:100,remainingIndex:201,routeState:'off',syncKey:"routing-source-"+new Date().getTime(),startImage:props.startImage||'routeStart',targetImage:props.targetImage||'routeTarget',directionImage:props.directionImage||'routeDirection',symbolLayerStyle:props.symbolLayerStyle||{iconImage:['get','image'],iconAllowOverlap:true,iconOffset:[0.5,0.5]},lineSymbolLayerStyle:props.lineSymbolLayerStyle||{iconImage:_this.props.directionImage||'routeDirection',iconAllowOverlap:true,symbolSpacing:100,symbolPlacement:'line'},remainingStyle:props.remainingStyle||remainingStyle,completedStyle:props.completedStyle||completedStyle,dottedLineStyle:props.dottedLineStyle||dottedLineStyle};return _this;}(0,_createClass2.default)(RoutingSource,[{key:"componentDidMount",value:function componentDidMount(){_instance.default.route.on(this.onRouteEvent);}},{key:"componentDidUpdate",value:function componentDidUpdate(prevProps){var _this2=this;if(!(0,_react2.default)(this.props,prevProps)){this.setState({startImage:this.props.startImage||'routeStart',targetImage:this.props.targetImage||'routeTarget',directionImage:this.props.directionImage||'routeDirection',symbolLayerStyle:this.props.symbolLayerStyle||{iconImage:['get','image'],iconAllowOverlap:true,iconOffset:[0.5,0.5]},lineSymbolLayerStyle:this.props.lineSymbolLayerStyle||{iconImage:this.props.directionImage||'routeDirection',iconAllowOverlap:true,symbolPlacement:'line'},dottedLineStyle:this.props.dottedLineStyle||dottedLineStyle},function(){_this2.update();});}}},{key:"componentWillUnmount",value:function componentWillUnmount(){_instance.default.route.off(this.onRouteEvent);}},{key:"render",value:function render(){var aboveLayerID=this.props.aboveLayerID||_constants.default.LAYER_POLYGONS_ABOVE_PATHS;var syncKey=new Date().getTime();return _react.default.createElement(_maps.default.ShapeSource,{id:"routes",key:syncKey,shape:this.state.collection,maxZoomLevel:24,__self:this,__source:{fileName:_jsxFileName,lineNumber:320,columnNumber:12}},!this.props.dotted&&_react.default.createElement(_maps.default.LineLayer,{id:_constants.default.LAYER_ROUTING_LINE_REMAINING,key:_constants.default.LAYER_ROUTING_LINE_REMAINING+":"+syncKey,style:this.state.remainingStyle,filter:this.state.remainingFilter,aboveLayerID:aboveLayerID,belowLayerID:_constants.default.LAYER_USER_MARKER_CONE,__self:this,__source:{fileName:_jsxFileName,lineNumber:326,columnNumber:33}}),!this.props.dotted&&_react.default.createElement(_maps.default.LineLayer,{id:_constants.default.LAYER_ROUTING_LINE_COMPLETED,key:""+_constants.default.LAYER_ROUTING_LINE_COMPLETED+syncKey,style:this.state.completedStyle,filter:this.state.completedFilter,belowLayerID:_constants.default.LAYER_ROUTING_LINE_REMAINING,__self:this,__source:{fileName:_jsxFileName,lineNumber:335,columnNumber:33}}),!this.props.dotted&&_react.default.createElement(_maps.default.SymbolLayer,{id:_constants.default.LAYER_ROUTING_DIRECTION,key:""+_constants.default.LAYER_ROUTING_DIRECTION+syncKey,style:this.state.lineSymbolLayerStyle,filter:this.state.lineSymbolFilter,aboveLayerID:_constants.default.LAYER_ROUTING_LINE_REMAINING,__self:this,__source:{fileName:_jsxFileName,lineNumber:343,columnNumber:33}}),this.props.dotted&&_react.default.createElement(_maps.default.SymbolLayer,{id:_constants.default.LAYER_ROUTING_LINE_DOTTED,key:""+_constants.default.LAYER_ROUTING_LINE_DOTTED+syncKey,aboveLayerID:aboveLayerID,filter:dottedLineFilter,style:this.state.dottedLineStyle,__self:this,__source:{fileName:_jsxFileName,lineNumber:351,columnNumber:30}}),_react.default.createElement(_maps.default.SymbolLayer,{id:_constants.default.LAYER_ROUTING_SYMBOLS,key:""+_constants.default.LAYER_ROUTING_SYMBOLS+syncKey,style:this.state.symbolLayerStyle,filter:this.state.symbolFilter,aboveLayerID:this.props.dotted?_constants.default.LAYER_ROUTING_LINE_DOTTED:_constants.default.LAYER_ROUTING_DIRECTION,__self:this,__source:{fileName:_jsxFileName,lineNumber:358,columnNumber:7}}));}}]);return RoutingSource;}(_react.default.Component);exports.RoutingSource=RoutingSource;
//# sourceMappingURL=routing_source.js.map