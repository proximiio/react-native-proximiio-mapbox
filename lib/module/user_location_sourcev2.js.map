{"version":3,"sources":["user_location_sourcev2.tsx"],"names":["accuracyFilterFor","isIOS","markerFilterFor","defaultOptions","aboveLayer","Constants","LAYER_POLYGONS_ABOVE_PATHS","markerStyle","iconImage","iconSize","iconAllowOverlap","accuracyStyle","fillColor","fillOpacity","getCollection","location","type","features","geometry","coordinates","lng","lat","accuracy","properties","usecase","icon","UserLocationSource","Proximiio","state","setState","ProximiioMapbox","subscribe","ProximiioMapboxEvents","STYLE_CHANGED","onChange","FEATURES_CHANGED","LOCATION_UPDATED","onLocationChanged","unsubscribe","_options","props","options","collection","SOURCE_USER_LOCATION","Date","getTime","LAYER_USER_ACCURACY","style","layers","length","LAYER_USER_MARKER","React","Component"],"mappings":"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","sourcesContent":["import React from 'react';\nimport { StyleProp} from 'react-native';\nimport MapboxGL, {\n  Expression,\n  FillLayerStyle,\n  SymbolLayerStyle,\n} from '@react-native-mapbox-gl/maps';\nimport Proximiio, { ProximiioLocation } from 'react-native-proximiio';\nimport ProximiioMapbox, { ProximiioMapboxEvents } from './instance';\n\nimport Constants from './constants';\nimport { isIOS, createGeoJSONCircle } from './helpers';\nimport { ProximiioFeatureType, FeatureCollection } from './types';\n\nexport type UserLocationSourceOptions = {\n  aboveLayer?: string\n  markerStyle?: StyleProp<SymbolLayerStyle>\n  accuracyStyle?: StyleProp<FillLayerStyle>\n};\n\ninterface Props {\n  options?: UserLocationSourceOptions\n}\n\nconst accuracyFilterFor = () => (isIOS ?\n    [\n      'all',\n      ['==', 'usecase', 'user-location-accuracy'],\n    ] :\n    [\n      'all',\n      ['==', ['get', 'usecase'], 'user-location-accuracy'],\n    ]\n) as Expression;\n\nconst markerFilterFor = () => (isIOS ?\n    [\n      'all',\n      ['==', 'usecase', 'user-location'],\n    ] :\n    [\n      'all',\n      ['==', ['get', 'usecase'], 'user-location'],\n    ]\n) as Expression;\n\nconst defaultOptions = {\n  aboveLayer: Constants.LAYER_POLYGONS_ABOVE_PATHS,\n  markerStyle: {\n    iconImage: ['get', 'icon'] as Expression,\n    iconSize: 0.5,\n    iconAllowOverlap: true\n  },\n  accuracyStyle: {\n    fillColor: '#0080c0',\n    fillOpacity: 0.3,\n  },\n};\n\nconst getCollection = (location: ProximiioLocation): FeatureCollection => ({\n  type: 'FeatureCollection',\n  features: [\n    {\n      type: 'Feature',\n      geometry: {\n        type: 'Polygon',\n        coordinates: [\n          createGeoJSONCircle(\n            [location.lng, location.lat],\n            (location.accuracy || 50) / 1000,\n            50\n          ),\n        ],\n      },\n      properties: {\n        usecase: 'user-location-accuracy',\n      },\n    } as ProximiioFeatureType,\n    {\n      type: 'Feature',\n      geometry: {\n        type: 'Point',\n        coordinates: [location.lng, location.lat],\n      },\n      properties: {\n        usecase: 'user-location',\n        icon: 'bluedot',\n      },\n    } as ProximiioFeatureType\n  ],\n})\n\ninterface State {\n  location?: ProximiioLocation\n}\n\nexport class UserLocationSource extends React.Component<Props, State> {\n  state = {\n    location: Proximiio.location\n  } as State\n\n  componentDidMount() {\n    ProximiioMapbox.subscribe(ProximiioMapboxEvents.STYLE_CHANGED, this.onChange);\n    ProximiioMapbox.subscribe(ProximiioMapboxEvents.FEATURES_CHANGED, this.onChange);\n    ProximiioMapbox.subscribe(ProximiioMapboxEvents.LOCATION_UPDATED, this.onLocationChanged);\n  }\n\n  componentWillUnmount() {\n    ProximiioMapbox.unsubscribe(ProximiioMapboxEvents.STYLE_CHANGED, this.onChange);\n    ProximiioMapbox.unsubscribe(ProximiioMapboxEvents.FEATURES_CHANGED, this.onChange);\n    ProximiioMapbox.unsubscribe(ProximiioMapboxEvents.LOCATION_UPDATED, this.onLocationChanged);\n  }\n\n  private onChange = () => {\n    if (!this.state.location) {\n      return\n    }\n  }\n\n  private onLocationChanged = (location: ProximiioLocation) => {\n    this.setState({location: location});\n  }\n\n  public render() {\n    const _options = {\n      ...defaultOptions,\n      ...this.props.options\n    };\n\n    if (!this.state.location) {\n      return null\n    }\n\n    const collection = getCollection(this.state.location);\n\n    return (\n      <MapboxGL.ShapeSource\n        id={Constants.SOURCE_USER_LOCATION}\n        key={Constants.SOURCE_USER_LOCATION + new Date().getTime()}\n        shape={collection}\n        cluster={false}\n        maxZoomLevel={24}\n      >\n        <MapboxGL.FillLayer\n          id={Constants.LAYER_USER_ACCURACY}\n          key={Constants.LAYER_USER_ACCURACY + new Date().getTime()}\n          filter={accuracyFilterFor()}\n          style={_options.accuracyStyle}\n          layerIndex={ProximiioMapbox.style.layers.length * 2}\n          // aboveLayerID={Constants.LAYER_POLYGONS_ABOVE_PATHS}\n        />\n        <MapboxGL.SymbolLayer\n          id={Constants.LAYER_USER_MARKER}\n          key={Constants.LAYER_USER_MARKER}\n          filter={markerFilterFor()}\n          style={_options.markerStyle}\n          layerIndex={ProximiioMapbox.style.layers.length * 2}\n          // aboveLayerID={Constants.LAYER_USER_ACCURACY}\n        />\n      </MapboxGL.ShapeSource>\n    )\n  }\n}\n"]}