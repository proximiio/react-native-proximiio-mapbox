{"version":3,"sources":["routing_source.tsx"],"names":["completedStyle","lineCap","lineJoin","lineOpacity","lineColor","lineWidth","remainingStyle","completedFilterWithLevel","level","remainingFilterWithLevel","symbolFilterWithLevel","lineSymbolFilterWithLevel","RoutingSource","props","event","ProximiioRouteEvents","ROUTE_ENDED","onRouteCanceled","ROUTE_CALCULATED","onRoutePreview","ROUTE_PREVIEWED","ROUTE_UPDATED","onRouteUpdated","routeState","update","setState","ProximiioMapbox","style","setRouteState","route","routeStarted","collection","type","features","previewedOrStarted","routePreviewed","showSymbols","length","startIdx","findIndex","f","id","targetIdx","feats","filter","startCoords","geometry","coordinates","start","Feature","point","image","state","startImage","properties","lastFeature","targetCoords","target","targetImage","push","splice","completedFilter","remainingFilter","symbolFilter","lineSymbolFilter","syncKey","Date","getTime","setTimeout","completedIndex","remainingIndex","directionImage","symbolLayerStyle","iconImage","iconAllowOverlap","iconOffset","lineSymbolLayerStyle","symbolSpacing","symbolPlacement","on","onRouteEvent","prevProps","unsubscribe","ProximiioMapboxEvents","READY","onReady","off","aboveLayerID","Constants","LAYER_POLYGONS_ABOVE_PATHS","LAYER_ROUTING_LINE_REMAINING","LAYER_ROUTING_LINE_COMPLETED","LAYER_ROUTING_DIRECTION","LAYER_ROUTING_SYMBOLS","React","Component"],"mappings":"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","sourcesContent":["import React from 'react'\nimport MapboxGL, { Expression, LineLayerStyle, SymbolLayerStyle } from '@react-native-mapbox-gl/maps'\nimport equal from 'fast-deep-equal/react'\nimport ProximiioMapbox, { ProximiioMapboxEvents  } from './instance'\nimport { FeatureCollection, ProximiioFeatureType } from './types'\nimport { ProximiioRouteEvents } from './route_managerv2'\nimport Constants from './constants'\nimport { Feature } from './feature'\n\nconst completedStyle = {\n  lineCap: 'round',\n  lineJoin: 'round',\n  lineOpacity: 0.15,\n  lineColor: '#39c6e1',\n  lineWidth: 10\n} as LineLayerStyle\n\nconst remainingStyle = {\n  lineCap: 'round',\n  lineJoin: 'round',\n  lineOpacity: 0.9,\n  lineColor: '#39c6e1',\n  lineWidth: 10\n} as LineLayerStyle\n\nconst completedFilterWithLevel = (level: number) => [\n  \"all\",\n  [\"==\", [\"geometry-type\"], \"LineString\"],\n  [\"has\", \"completed\"],\n  [\"==\", [\"to-number\", [\"get\", \"level\"]], level]\n] as Expression\n\nconst remainingFilterWithLevel = (level: number) => [\n  \"all\",\n  [\"==\", [\"geometry-type\"], \"LineString\"],\n  [\"==\", [\"to-number\", [\"get\", \"level\"]], level]\n] as Expression\n\nconst symbolFilterWithLevel = (level: number) => [\n  \"all\",\n  [\"==\", [\"geometry-type\"], \"Point\"],\n  [\"==\", [\"to-number\", [\"get\", \"level\"]], level]\n] as Expression\n\nconst lineSymbolFilterWithLevel = (level: number) => [\n  \"all\",\n  [\"==\", [\"geometry-type\"], \"LineString\"],\n  [\"==\", [\"to-number\", [\"get\", \"level\"]], level]\n] as Expression\n\nexport type RouteState = 'preview' | 'started' | 'canceled' | 'off';\n\ninterface Props {\n  aboveLayerID?: string\n  level: number\n  showSymbols?: boolean\n  startImage?: string\n  targetImage?: string\n  directionImage?: string\n  symbolLayerStyle?: SymbolLayerStyle\n  lineSymbolLayerStyle?: SymbolLayerStyle\n  completedStyle?: LineLayerStyle\n  remainingStyle?: LineLayerStyle\n}\n\ninterface State {\n  // route: ProximiioRoute\n  collection: FeatureCollection\n  completedFilter: Expression\n  remainingFilter: Expression\n  symbolFilter: Expression\n  lineSymbolFilter: Expression\n  completedIndex: number\n  remainingIndex: number\n  routeState: RouteState\n  syncKey: string\n  startImage: string\n  targetImage: string\n  directionImage: string\n  symbolLayerStyle: SymbolLayerStyle\n  lineSymbolLayerStyle: SymbolLayerStyle\n  completedStyle: LineLayerStyle\n  remainingStyle: LineLayerStyle\n}\n\nexport class RoutingSource extends React.Component<Props, State> {\n  constructor(props: Props) {\n    super(props);\n    this.state = {\n      // route: new ProximiioRoute([]),\n      collection: { type: 'FeatureCollection', features: [] } as FeatureCollection,\n      completedFilter: completedFilterWithLevel(props.level),\n      remainingFilter: remainingFilterWithLevel(props.level),\n      symbolFilter: symbolFilterWithLevel(props.level),\n      lineSymbolFilter: lineSymbolFilterWithLevel(props.level),\n      completedIndex: 100,\n      remainingIndex: 201,\n      routeState: 'off',\n      syncKey: `routing-source-${new Date().getTime()}`,\n      startImage: props.startImage || 'routeStart',\n      targetImage:  props.targetImage ||'routeTarget',\n      directionImage: props.directionImage || 'routeDirection',\n      symbolLayerStyle: props.symbolLayerStyle || {\n        iconImage: ['get', 'image'],\n        iconAllowOverlap: true,\n        iconOffset: [0.5, 0.5],\n      },\n      lineSymbolLayerStyle: props.lineSymbolLayerStyle || {\n        iconImage: this.props.directionImage || 'routeDirection',\n        iconAllowOverlap: true,\n        symbolSpacing: 100,\n        symbolPlacement: 'line',\n      },\n      remainingStyle: props.remainingStyle || remainingStyle,\n      completedStyle: props.completedStyle || completedStyle\n    }\n  }\n\n  componentDidMount() {\n    ProximiioMapbox.route.on(this.onRouteEvent);\n  }\n\n  componentDidUpdate(prevProps: Props) {\n    if (!equal(this.props, prevProps)) {\n      this.setState({\n        startImage: this.props.startImage || 'routeStart',\n        targetImage:  this.props.targetImage ||'routeTarget',\n        directionImage:  this.props.directionImage ||'routeDirection',\n        symbolLayerStyle: this.props.symbolLayerStyle || {\n          iconImage: ['get', 'image'],\n          iconAllowOverlap: true,\n          iconOffset: [0.5, 0.5],\n        },\n        lineSymbolLayerStyle: this.props.lineSymbolLayerStyle || {\n          iconImage: this.props.directionImage || 'routeDirection',\n          iconAllowOverlap: true,\n          symbolPlacement: 'line',\n        }\n      }, () => {\n        this.update()\n      })\n    }\n  }\n\n  componentWillUnmount() {\n    ProximiioMapbox.unsubscribe(ProximiioMapboxEvents.READY, this.onReady);\n    ProximiioMapbox.route.off(this.onRouteEvent);\n  }\n\n  private onRouteEvent = (event: string) => {\n\n\n    if (event === ProximiioRouteEvents.ROUTE_ENDED) {\n      this.onRouteCanceled();\n    } else if (event == ProximiioRouteEvents.ROUTE_CALCULATED) {\n      // TODO handle this event properly??\n      this.onRoutePreview();\n    } else if (event === ProximiioRouteEvents.ROUTE_PREVIEWED) {\n      this.onRoutePreview();\n    } else if (event === ProximiioRouteEvents.ROUTE_UPDATED) {\n      this.onRouteUpdated();\n    }\n  }\n\n  private setRouteState = async (routeState: RouteState) => {\n    await this.update();\n    await this.setState({ routeState })\n  }\n\n  onReady = async () => {\n    if (ProximiioMapbox.style) {\n      this.setRouteState('off')\n    }\n  }\n\n  onRoutePreview = async () => {\n    if (ProximiioMapbox.route.route) {\n      this.setRouteState('preview')\n    }\n  }\n\n  onRouteStarted = async () => {\n    if (ProximiioMapbox.route.route) {\n      this.setRouteState('started')\n    }\n  }\n\n  onRouteUpdated = () => {\n    if (ProximiioMapbox.route.routeStarted) {\n      this.update()\n    }\n  }\n\n  onRouteCanceled = async () => {\n    await this.setRouteState('off')\n    await this.setState({\n      collection: {\n        type: 'FeatureCollection',\n        features: []\n      }\n    })\n  }\n\n  update = async () => {\n    const route = ProximiioMapbox.route.route;\n    const previewedOrStarted = ProximiioMapbox.route.routePreviewed || ProximiioMapbox.route.routeStarted;\n    const features = (previewedOrStarted && route) ? route.features : [];\n\n    if (this.props.showSymbols && features.length > 0) {\n      const startIdx = features.findIndex(f => f.id === 'route-start');\n      const targetIdx = features.findIndex(f => f.id === 'route-target');\n      const feats = startIdx >= 0 ? features.filter(f => typeof f.id === 'undefined') : features;\n      const startCoords = features[0].geometry.coordinates[0];\n      const start = Feature.point('route-start', startCoords[1], startCoords[0], {\n        image: this.state.startImage,\n        level: features[0].properties.level\n      }) as ProximiioFeatureType;\n\n      const lastFeature = feats[feats.length - 1];\n      const targetCoords = lastFeature.geometry.coordinates[lastFeature.geometry.coordinates.length - 1];\n\n      const target = Feature.point('route-target', targetCoords[1], targetCoords[0], {\n        image: this.state.targetImage,\n        level: lastFeature.properties.level\n      }) as ProximiioFeatureType;\n\n      if (startIdx === -1) {\n        features.push(start);\n      } else {\n        features.splice(startIdx, 1, start);\n      }\n\n      if (targetIdx === -1) {\n        features.push(target);\n      } else {\n        features.splice(targetIdx, 1, target);\n      }\n    }\n\n    this.setState({\n      collection: {\n        type: 'FeatureCollection',\n        features\n      },\n      completedFilter: completedFilterWithLevel(this.props.level),\n      remainingFilter: remainingFilterWithLevel(this.props.level),\n      symbolFilter: symbolFilterWithLevel(this.props.level),\n      lineSymbolFilter: lineSymbolFilterWithLevel(this.props.level),\n      syncKey: `routing-source-${new Date().getTime()}`\n    }, () => {\n      // rn mapbox drawing order issue workaround\n      setTimeout(() => {\n        this.setState({ syncKey: `routing-source-${new Date().getTime()}` })\n      }, 1000)\n    })\n  }\n\n  public render() {\n    const aboveLayerID = this.props.aboveLayerID || Constants.LAYER_POLYGONS_ABOVE_PATHS\n    const syncKey = new Date().getTime();\n\n    return <MapboxGL.ShapeSource\n      id=\"routes\"\n      key={this.state.syncKey}\n      shape={this.state.collection}\n      maxZoomLevel={24}>\n\n      <MapboxGL.LineLayer\n        id={Constants.LAYER_ROUTING_LINE_REMAINING}\n        key={`${Constants.LAYER_ROUTING_LINE_REMAINING}:${syncKey}`}\n        style={this.state.remainingStyle}\n        filter={this.state.remainingFilter}\n        aboveLayerID={aboveLayerID}\n      />\n\n      <MapboxGL.LineLayer\n        id={Constants.LAYER_ROUTING_LINE_COMPLETED}\n        key={`${Constants.LAYER_ROUTING_LINE_COMPLETED}${syncKey}`}\n        style={this.state.completedStyle}\n        filter={this.state.completedFilter}\n        belowLayerID={Constants.LAYER_ROUTING_LINE_REMAINING}\n      />\n\n      <MapboxGL.SymbolLayer\n        id={Constants.LAYER_ROUTING_DIRECTION}\n        key={`${Constants.LAYER_ROUTING_DIRECTION}${syncKey}`}\n        style={this.state.lineSymbolLayerStyle}\n        filter={this.state.lineSymbolFilter}\n        aboveLayerID={Constants.LAYER_ROUTING_LINE_REMAINING}\n      />\n\n      <MapboxGL.SymbolLayer\n        id={Constants.LAYER_ROUTING_SYMBOLS}\n        key={`${Constants.LAYER_ROUTING_SYMBOLS}${syncKey}`}\n        style={this.state.symbolLayerStyle}\n        filter={this.state.symbolFilter}\n        aboveLayerID={Constants.LAYER_ROUTING_DIRECTION}\n      />\n\n    </MapboxGL.ShapeSource>\n  }\n}\n"]}